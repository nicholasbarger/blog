{"id":"an-example-of-writing-your-own-blog-engine-(mini-version)-part-three","title":"An Example of Writing Your Own Blog Engine (mini-version) Part Three","description":"","link":"http://nicholasbarger.com/2008/08/17/an-example-of-writing-your-own-blog-engine-mini-version-part-three/","pubDate":"2008-08-17T18:23:15.000Z","content":"<p>This is a three part series, if you haven't already read part one, you may want to start there (<a href=\"http://nicholasbarger.com/16-An_Example_of_Writing_Your_Own_Blog_Engine_(mini-version)\">An Example of Writing Your Own Blog Engine (mini-version)</a>), or part two (<a href=\"http://nicholasbarger.com/17-An_Example_of_Writing_Your_Own_Blog_Engine_(mini-version)_Part_Two\">An Example of Writing Your Own Blog Engine (mini-version) Part Two</a>).</p>        <h2>Presentation Layer</h2>    <p>Ok, well this will be the last piece to the puzzle and we're going to start with the main thread which will house the featured blog post itself as well as a mechanism for handling comments.  We want to make it in such a way that we can easily control the number of blog posts that are displayed.  For example, if we wanted to display one featured post (the most recent in this example), or allow a user to select a month and display all blog posts for that month.  It seems to me that a repeater sounds like a nice, flexible, .NET control to handle this situation.&nbsp;         Here is the following HTML I used, you can of course change this to however fits         your needs.</p>        <h3>HTML and ASP.NET Controls</h3>    <div class=\"html_block\"><pre>&lt;asp:Repeater ID=\"rptMainList\" runat=\"server\"&gt;    &lt;ItemTemplate&gt;        &lt;!-- Blog date --&gt;        &lt;div&gt;&lt;asp:Literal ID=\"litPublishDate\" runat=\"server\" Text='&lt;%#Eval(\"PubDate\").ToLongDateString()%&gt;'&gt;&lt;/asp:Literal&gt;&lt;/div&gt;        &lt;hr /&gt;        &lt;h1&gt;&lt;asp:Literal ID=\"litBlogTitle\" runat=\"server\" Text='&lt;%#Eval(\"Title\")%&gt;'&gt;&lt;/asp:Literal&gt;&lt;/h1&gt;        &lt;asp:Literal ID=\"litBlogPost\" runat=\"server\" Text='&lt;%#Eval(\"Description\")%&gt;'&gt;&lt;/asp:Literal&gt;                &lt;asp:HiddenField ID=\"hdnBlogID\" runat=\"server\" Value='&lt;%#Eval(\"BlogID\")%&gt;' /&gt;                &lt;hr /&gt;        &lt;!-- Blog: Add a comment --&gt;        &lt;table cellpadding=\"2\" cellspacing=\"4\" width=\"100%\"&gt;            &lt;tr&gt;                &lt;td style=\"width: 35%;\"&gt;Enter your name:&lt;/td&gt;                &lt;td style=\"width: 65%;\"&gt;Have a comment? Post it here.&lt;/td&gt;            &lt;/tr&gt;            &lt;tr&gt;                &lt;td&gt;&lt;input type=\"text\" id=\"tbName\" runat=\"server\" style=\"width: 100%;\" /&gt;&lt;/td&gt;                &lt;td rowspan=\"5\" style=\"vertical-align: top;\"&gt;&lt;textarea id=\"tbComment\" runat=\"server\" cols=\"1\" rows=\"1\"&gt;&lt;/textarea&gt;&lt;/td&gt;           &lt;/tr&gt;            &lt;tr&gt;                &lt;td&gt;Enter your email:&lt;/td&gt;            &lt;/tr&gt;            &lt;tr&gt;                &lt;td&gt;&lt;input type=\"text\" id=\"tbEmail\" runat=\"server\" style=\"width: 100%;\" /&gt;&lt;/td&gt;            &lt;/tr&gt;            &lt;tr&gt;                &lt;td&gt;Enter your URL here:&lt;/td&gt;            &lt;/tr&gt;            &lt;tr&gt;                &lt;td&gt;&lt;input type=\"text\" id=\"tbURL\" runat=\"server\" style=\"width: 100%;\" /&gt;&lt;/td&gt;            &lt;/tr&gt;            &lt;tr&gt;                &lt;td colspan=\"2\" style=\"text-align: right;\"&gt;                    &lt;asp:LinkButton ID=\"btnPostComment\" runat=\"server\" Text=\"add comment\" CommandName=\"PostComment\"&gt;&lt;/asp:LinkButton&gt;                &lt;/td&gt;            &lt;/tr&gt;        &lt;/table&gt;        &lt;hr /&gt;        &lt;!-- Blog: Previous comments --&gt;        &lt;asp:UpdatePanel ID=\"upnlBlogComments\" runat=\"server\"&gt;        &lt;Triggers&gt;            &lt;asp:AsyncPostBackTrigger ControlID=\"btnPostComment\" EventName=\"Click\" /&gt;            &lt;asp:AsyncPostBackTrigger ControlID=\"rptMainList\" EventName=\"ItemCommand\" /&gt;        &lt;/Triggers&gt;        &lt;ContentTemplate&gt;            &lt;asp:Repeater ID=\"rptBlogComments\" runat=\"server\" OnItemDataBound=\"rptBlogComments_ItemDatabound\"&gt;                &lt;HeaderTemplate&gt;                    &lt;table cellpadding=\"2\" cellspacing=\"4\" width=\"100%\" class=\"comments\"&gt;                        &lt;tr&gt;                            &lt;td colspan=\"2\"&gt;&lt;h3 style=\"padding-bottom: 0px; margin-bottom: 0px;\"&gt;&lt;span style=\"color: Black;\"&gt;&lt;asp:Label ID=\"lblNumberOfComments\" runat=\"server\"&gt;&lt;/asp:Label&gt;&lt;/span&gt; Comments&lt;/h3&gt;&lt;/td&gt;                        &lt;/tr&gt;                &lt;/HeaderTemplate&gt;                &lt;ItemTemplate&gt;                        &lt;tr&gt;                            &lt;td&gt;                                &lt;asp:Label ID=\"lblDate\" runat=\"server\"&gt;&lt;/asp:Label&gt;&lt;br /&gt;                                &lt;asp:Label ID=\"lblPoster\" runat=\"server\"&gt;&lt;/asp:Label&gt;&lt;br /&gt;                                &lt;asp:HyperLink ID=\"lnkURL\" runat=\"server\"&gt;&lt;/asp:HyperLink&gt;                            &lt;/td&gt;                            &lt;td style=\"padding-left: 25px;\"&gt;                                &lt;asp:Label ID=\"lblComment\" runat=\"server\" Text=\"\"&gt;&lt;/asp:Label&gt;                            &lt;/td&gt;                        &lt;/tr&gt;                &lt;/ItemTemplate&gt;                &lt;AlternatingItemTemplate&gt;                        &lt;tr&gt;                            &lt;td colspan=\"2\"&gt;&lt;hr /&gt;&lt;/td&gt;                        &lt;/tr&gt;                        &lt;tr&gt;                            &lt;td&gt;                                &lt;asp:Label ID=\"lblDate\" runat=\"server\"&gt;&lt;/asp:Label&gt;&lt;br /&gt;                                &lt;asp:Label ID=\"lblPoster\" runat=\"server\"&gt;&lt;/asp:Label&gt;&lt;br /&gt;                                &lt;asp:HyperLink ID=\"lnkURL\" runat=\"server\"&gt;&lt;/asp:HyperLink&gt;                            &lt;/td&gt;                            &lt;td style=\"padding-left: 25px;\"&gt;                                &lt;asp:Label ID=\"lblComment\" runat=\"server\" Text=\"\"&gt;&lt;/asp:Label&gt;                            &lt;/td&gt;                        &lt;/tr&gt;                        &lt;tr&gt;                            &lt;td colspan=\"2\"&gt;&lt;hr /&gt;&lt;/td&gt;                        &lt;/tr&gt;                &lt;/AlternatingItemTemplate&gt;                &lt;FooterTemplate&gt;                    &lt;/table&gt;                &lt;/FooterTemplate&gt;            &lt;/asp:Repeater&gt;        &lt;/ContentTemplate&gt;        &lt;/asp:UpdatePanel&gt;    &lt;/ItemTemplate&gt;&lt;/asp:Repeater&gt;</pre>    </div>        <h3>VB Code for Handling the Main Post</h3>    <p>Now, we also need a bit of code to handle working with the blog post itself, we'll reference what we created in the business layer to do this.  Notice the use of a helper function to handle repetive code, this is good practice to reduce redundant code making maintenance easier.  Also, I prefer to standardize the way I title these types of functions, it will also help in ease of maintenance.</p>    <div class=\"vb_block\"><pre>Private _blogbll As BlogBLLPublic Property BlogAdapter() As BlogBLL    Get        If _blogbll Is Nothing Then            _blogbll = New BlogBLL        End If        Return _blogbll    End Get    Set(ByVal value As BlogBLL)        _blogbll = value    End SetEnd Property''' &lt;summary&gt;''' Get's most recent blog post.''' &lt;/summary&gt;''' &lt;remarks&gt;&lt;/remarks&gt;Private Sub GetBlogPost()    Dim blogPostDT As Blog.BlogPostsViewDataTable = BlogAdapter.GetMostRecentBlogPost()    Try        GetBlogPost_Helper(blogPostDT)    Catch ex As Exception        'If this fails, it means there are no blog posts in database at all        'Should maybe redirect to a plain / non-blog page        Exit Sub    End TryEnd Sub''' &lt;summary&gt;''' Get's specific blog post.''' &lt;/summary&gt;''' &lt;param name=\"BlogID\"&gt;&lt;/param&gt;''' &lt;remarks&gt;&lt;/remarks&gt;Private Sub GetBlogPost(ByVal blogID As Integer)    Dim blogPostDT As Blog.BlogPostsViewDataTable = BlogAdapter.GetBlogPost(blogID)    GetBlogPost_Helper(blogPostDT)End Sub''' &lt;summary&gt;''' Get's all blog posts for a given month/year (archived posts)''' &lt;/summary&gt;''' &lt;param name=\"month\"&gt;&lt;/param&gt;''' &lt;param name=\"year\"&gt;&lt;/param&gt;''' &lt;remarks&gt;&lt;/remarks&gt;Private Sub GetBlogPost(ByVal month As Integer, ByVal year As Integer)    Dim blogPostDT As Blog.BlogPostsViewDataTable = BlogAdapter.GetBlogPosts(month, year)    GetBlogPost_Helper(blogPostDT)End SubPrivate Sub GetBlogPost_Helper(ByVal blogPostDR As Blog.BlogPostsViewDataTable)    rptMainList.DataSource = blogPostDR    rptMainList.DataBind()End SubProtected Sub rptBlogPosts_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rptBlogPosts.ItemDataBound    Select Case e.Item.ItemType        Case ListItemType.Item            rptBlogPosts_Helper(sender, e)        Case ListItemType.AlternatingItem            rptBlogPosts_Helper(sender, e)    End SelectEnd SubPrivate Sub rptBlogPosts_Helper(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs)    Dim lnkBlogPost As HyperLink = DirectCast(e.Item.FindControl(\"lnkBlogPost\"), HyperLink)    Dim title As String = e.Item.DataItem(\"Title\").ToString().Replace(\" \", \"_\").Replace(\".\", \"\").Replace(\",\", \"\")    lnkBlogPost.Text = e.Item.DataItem(\"Title\").ToString()    'lnkBlogPost.NavigateUrl = String.Format(\"default.aspx?blogid={0}\", e.Item.DataItem(\"BlogID\").ToString())    lnkBlogPost.NavigateUrl = String.Format(\"{0}-{1}\", e.Item.DataItem(\"BlogID\").ToString(), title)End Sub</pre>    </div>        <h3>VB Code for Handling Blog Comments</h3>    <p>The same needs to be done with the blog comments.</p>    <div class=\"vb_block\"><pre>Private Sub rptBlogComments_Helper(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs)    Dim lblDate As Label = DirectCast(e.Item.FindControl(\"lblDate\"), Label)    Dim lblPoster As Label = DirectCast(e.Item.FindControl(\"lblPoster\"), Label)    Dim lnkURL As HyperLink = DirectCast(e.Item.FindControl(\"lnkURL\"), HyperLink)    Dim lblComment As Label = DirectCast(e.Item.FindControl(\"lblComment\"), Label)    Dim dateCreated As DateTime    Dim pubDate As String = \"Unknown\"    Try        dateCreated = e.Item.DataItem(\"PubDate\")        pubDate = dateCreated.ToLongDateString()    Catch ex As Exception    End Try    lblDate.Text = pubDate    Dim poster As String = e.Item.DataItem(\"Username\").ToString()    If String.IsNullOrEmpty(poster) = True Then        poster = \"anonymous\"    End If    lblPoster.Text = poster    lblComment.Text = e.Item.DataItem(\"Comment\").ToString()    Dim url As String = e.Item.DataItem(\"URL\").ToString()    lnkURL.Text = url    lnkURL.NavigateUrl = urlEnd SubProtected Sub rptBlogComments_ItemDatabound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs)    Select Case e.Item.ItemType        Case ListItemType.Header            Dim blogID As Integer = hdnTempBlogID.Value            Dim lblNumberOfComments As Label = DirectCast(e.Item.FindControl(\"lblNumberOfComments\"), Label)            lblNumberOfComments.Text = BlogAdapter.GetNumberOfBlogComments(blogID).ToString()        Case ListItemType.Item            rptBlogComments_Helper(sender, e)        Case ListItemType.AlternatingItem            rptBlogComments_Helper(sender, e)    End SelectEnd SubProtected Sub rptMainList_ItemCommand(ByVal source As Object, ByVal e As System.Web.UI.WebControls.RepeaterCommandEventArgs) Handles rptMainList.ItemCommand    Select Case e.CommandName        Case \"PostComment\"            Dim hdnBlogID As HiddenField = DirectCast(e.Item.FindControl(\"hdnBlogID\"), HiddenField)            Dim tbComment As HtmlTextArea = DirectCast(e.Item.FindControl(\"tbComment\"), HtmlTextArea)            Dim tbName As HtmlInputText = DirectCast(e.Item.FindControl(\"tbName\"), HtmlInputText)            Dim tbEmail As HtmlInputText = DirectCast(e.Item.FindControl(\"tbEmail\"), HtmlInputText)            Dim tbURL As HtmlInputText = DirectCast(e.Item.FindControl(\"tbURL\"), HtmlInputText)            Dim blogID As Integer = hdnBlogID.Value            Dim comment As String = tbComment.Value            Dim username As String = tbName.Value            Dim email As String = tbEmail.Value            Dim url As String = tbURL.Value            Try                BlogAdapter.CreateBlogComment(blogID, comment, username, email, url)            Catch ex As Exception                'FIX add error handling here            End Try            'Retrieve blog comments            Dim rptBlogComments As Repeater = DirectCast(e.Item.FindControl(\"rptBlogComments\"), Repeater)            rptBlogComments.DataSource = BlogAdapter.GetBlogComments(blogID)            rptBlogComments.DataBind()    End SelectEnd SubProtected Sub rptMainList_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rptMainList.ItemDataBound    hdnTempBlogID.Value = e.Item.DataItem(\"BlogID\")    'Retrieve blog comments    Dim rptBlogComments As Repeater = DirectCast(e.Item.FindControl(\"rptBlogComments\"), Repeater)    rptBlogComments.DataSource = BlogAdapter.GetBlogComments(e.Item.DataItem(\"BlogID\"))    rptBlogComments.DataBind()End Sub</pre>    </div>        <h3>Finally, the Trigger</h3>    <p>All the trigger does (in this case on page load) is handle the possible incoming data variations as well as kick off the whole process.  As you can see below we have a few variations of data that can be passed in (and more in the real blog and yours as you add to it).</p>    <p>First, no additional data can be passed in and the blog engine will default to the most recent post only.  Alternatively, you could pass in the month and year and retrieve a list of blog posts for that month.  And finally, you can pass in a blog id and retrieve a specific blog post to read.</p>    <div class=\"vb_block\"><pre>Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load    If Page.IsPostBack = False Then        Dim month As Integer = 0        Try            month = Integer.Parse(Request.QueryString(\"month\"))        Catch ex As Exception        End Try        Dim year As Integer = 0        Try            year = Integer.Parse(Request.QueryString(\"year\"))        Catch ex As Exception        End Try        Dim blogID As Integer = 0        Try            blogID = Integer.Parse(Request.QueryString(\"blogid\"))        Catch ex As Exception        End Try        If month &gt; 0 And year &gt; 0 Then            GetBlogPost(month, year)        ElseIf blogID &gt; 0 Then 'Populate requested blog post            GetBlogPost(blogID)        Else 'Populate most recent blog post            GetBlogPost()        End If    End IfEnd Sub</pre>    </div>        <p>And that's it!  In just three short installments we put together a basis for your very own blog engine which I encourage all of you to build upon, rewrite, improve, and generally play around with.  Please leave comments on new ideas for the blog engine, updates to how you've enhanced it, or any bugs found within this base (there's always a few).</p>"}